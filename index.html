<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nebula</title>
<style>
    /* Base styles */
    body {
        background-color: #000;
        color: #fff;
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        overflow-x: hidden;
        position: relative;
    }

    /* Loading Screen */
    .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.5s ease-out;
    }

    .loading-logo {
        width: 150px;
        height: 150px;
        animation: rotate 2s infinite linear;
    }

    @keyframes rotate {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .loading-text {
        margin-top: 20px;
        font-size: 24px;
        color: #9d4edd;
        text-shadow: 0 0 10px #9d4edd;
        animation: pulse 1.5s infinite ease-in-out;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 0.6;
        }
        50% {
            opacity: 1;
        }
    }

    .loading-progress {
        width: 200px;
        height: 4px;
        background-color: rgba(157, 78, 221, 0.3);
        margin-top: 20px;
        border-radius: 2px;
        overflow: hidden;
    }

    .loading-progress-bar {
        height: 100%;
        width: 0%;
        background-color: #9d4edd;
        box-shadow: 0 0 10px #9d4edd;
        transition: width 0.3s ease;
    }

    /* Animated background */
    .background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
    }

    .snow-container {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    .snowflake {
        position: absolute;
        background-color: white;
        border-radius: 50%;
        opacity: 0;
        pointer-events: none;
    }

    @keyframes fall {
        0% {
            transform: translateY(-5vh) translateX(0);
            opacity: 0;
        }
        10% {
            opacity: 0.7;
        }
        100% {
            transform: translateY(105vh) translateX(20px);
            opacity: 0.3;
        }
    }

    .container {
        width: 100%;
        max-width: 1200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem 1rem 1rem 1rem;
        position: relative;
        z-index: 1;
    }

    .title {
        font-size: 4rem;
        text-align: center;
        color: #fff;
        text-shadow: 0 0 10px #9d4edd, 0 0 20px #9d4edd, 0 0 30px #9d4edd;
        margin-bottom: 1.5rem;
    }

    /* Navigation and Profile */
    .nav-container {
        width: 100%;
        max-width: 800px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 1.5rem;
        position: relative;
    }

    .nav-tabs {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .profile-container {
        position: relative;
        margin-left: 20px;
    }

    .profile-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid #9d4edd;
        transition: box-shadow 0.3s ease;
        object-fit: cover;
    }

    .profile-icon:hover {
        box-shadow: 0 0 10px #9d4edd;
    }

    .profile-dropdown {
        position: absolute;
        top: 50px;
        right: 0;
        width: 200px;
        background-color: rgba(17, 17, 17, 0.95);
        border-radius: 5px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        padding: 15px;
        z-index: 100;
        display: none;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transform: translateY(-10px);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .profile-dropdown.active {
        display: block;
        transform: translateY(0);
        opacity: 1;
    }

    .profile-dropdown-item {
        padding: 10px;
        cursor: pointer;
        border-radius: 3px;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .profile-dropdown-item:hover {
        background-color: rgba(157, 78, 221, 0.2);
    }

    .profile-dropdown-item svg {
        width: 16px;
        height: 16px;
    }

    .profile-dropdown-divider {
        height: 1px;
        background-color: rgba(255, 255, 255, 0.1);
        margin: 10px 0;
    }

    /* Tabs */
    .tabs-container {
        width: 100%;
        max-width: 800px;
        margin-bottom: 2rem;
    }

    .tab {
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 5px;
        transition: all 0.3s ease;
        position: relative;
        background-color: transparent;
        color: rgba(255, 255, 255, 0.6);
        border: none;
        font-size: 16px;
    }

    .tab:hover {
        color: white;
        background-color: rgba(157, 78, 221, 0.1);
    }

    .tab.active {
        color: white;
        background-color: rgba(157, 78, 221, 0.2);
    }

    .tab.active::after {
        content: '';
        position: absolute;
        bottom: -5px;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: #9d4edd;
        box-shadow: 0 0 10px #9d4edd;
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.5s ease forwards;
        width: 100%;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Search and cart bar */
    .search-cart-container {
        display: flex;
        width: 100%;
        max-width: 800px;
        margin-bottom: 2.5rem;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .search-container {
        position: relative;
        flex: 1;
        max-width: 600px;
    }

    .search-input {
        width: 100%;
        padding: 12px 45px 12px 15px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        background-color: transparent;
        color: white;
        font-size: 16px;
        outline: none;
        transition: border-color 0.3s ease;
    }

    .search-input:focus {
        border-color: #9d4edd;
        box-shadow: 0 0 5px rgba(157, 78, 221, 0.5);
    }

    .search-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }

    .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255, 255, 255, 0.5);
        pointer-events: none;
    }

    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background-color: rgba(17, 17, 17, 0.95);
        border-radius: 0 0 5px 5px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        z-index: 50;
        max-height: 300px;
        overflow-y: auto;
        display: none;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-top: none;
    }

    .search-results.active {
        display: block;
    }

    .search-result-item {
        padding: 12px 15px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-item:hover {
        background-color: rgba(157, 78, 221, 0.2);
    }

    .search-result-image {
        width: 30px;
        height: 30px;
        object-fit: contain;
        background-color: rgba(0, 0, 0, 0.3);
        padding: 3px;
        border-radius: 3px;
    }

    .search-result-details {
        flex: 1;
    }

    .search-result-name {
        font-size: 14px;
        margin: 0;
    }

    .search-result-price {
        font-size: 12px;
        color: #9d4edd;
        margin: 0;
    }

    .cart-container {
        position: relative;
    }

    .cart-icon {
        background-color: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: border-color 0.3s ease;
    }

    .cart-icon:hover {
        border-color: #9d4edd;
    }

    .cart-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #9d4edd;
        color: white;
        font-size: 12px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .wishlist-dropdown {
        position: absolute;
        top: 55px;
        right: 0;
        width: 300px;
        background-color: rgba(17, 17, 17, 0.95);
        border-radius: 5px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        padding: 15px;
        z-index: 100;
        display: none;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transform: translateY(-10px);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .wishlist-dropdown.active {
        display: block;
        transform: translateY(0);
        opacity: 1;
    }

    .wishlist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .wishlist-title {
        font-size: 18px;
        font-weight: bold;
        margin: 0;
    }

    .wishlist-close {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 18px;
    }

    .wishlist-items {
        max-height: 300px;
        overflow-y: auto;
    }

    .wishlist-empty {
        text-align: center;
        padding: 20px 0;
        color: rgba(255, 255, 255, 0.5);
    }

    .wishlist-item {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .wishlist-item:hover {
        background-color: rgba(157, 78, 221, 0.1);
    }

    .wishlist-item-image {
        width: 40px;
        height: 40px;
        object-fit: contain;
        margin-right: 10px;
        background-color: rgba(0, 0, 0, 0.3);
        padding: 5px;
        border-radius: 3px;
        box-shadow: 0 0 5px #9d4edd;
    }

    .wishlist-item-details {
        flex: 1;
    }

    .wishlist-item-name {
        font-size: 14px;
        margin: 0 0 5px 0;
    }

    .wishlist-item-price {
        font-size: 14px;
        color: #9d4edd;
        margin: 0;
    }

    .wishlist-item-remove {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        font-size: 16px;
        padding: 5px;
    }

    .wishlist-item-remove:hover {
        color: #ff5555;
    }

    .keys-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1.5rem;
        width: 100%;
        max-width: 800px;
        backdrop-filter: blur(5px);
        background-color: rgba(0, 0, 0, 0.5);
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .key-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: transform 0.3s ease;
        position: relative;
    }

    .key-item:hover {
        transform: scale(1.05);
    }

    .key-image {
        width: 120px;
        height: 120px;
        object-fit: contain;
        border-radius: 10px;
        box-shadow: 0 0 10px #9d4edd, 0 0 15px #9d4edd;
        margin-bottom: 1rem;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 10px;
    }

    .key-label {
        font-size: 1.2rem;
        text-align: center;
        margin-top: 0.5rem;
    }

    .add-to-wishlist {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        transition: background-color 0.3s ease;
    }

    .add-to-wishlist:hover {
        background-color: #9d4edd;
    }

    /* Executor tab content */
    .executor-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 800px;
        backdrop-filter: blur(5px);
        background-color: rgba(0, 0, 0, 0.5);
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        text-align: center;
    }

    .not-available-message {
        font-size: 24px;
        color: rgba(255, 255, 255, 0.7);
        margin: 40px 0;
        text-align: center;
        line-height: 1.5;
    }

    .not-available-icon {
        font-size: 48px;
        margin-bottom: 20px;
        color: #9d4edd;
    }

    /* Support tab content */
    .support-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 800px;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .support-title {
        font-size: 24px;
        margin-bottom: 20px;
        text-align: center;
    }

    .support-description {
        text-align: center;
        margin-bottom: 30px;
        line-height: 1.6;
    }

    .discord-button {
        display: flex;
        align-items: center;
        gap: 10px;
        background-color: #5865F2;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 5px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.3s ease;
        margin-bottom: 30px;
        text-decoration: none;
    }

    .discord-button:hover {
        background-color: #4752C4;
        transform: translateY(-2px);
    }

    /* AI Chat tab content */
    .chat-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 800px;
        height: 500px;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        overflow: hidden;
    }

    .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background-color: rgba(17, 17, 17, 0.8);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-title {
        font-size: 18px;
        font-weight: bold;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chat-title-icon {
        color: #9d4edd;
    }

    .chat-status {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        background-color: #4CAF50;
        border-radius: 50%;
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .chat-message {
        display: flex;
        margin-bottom: 10px;
        max-width: 80%;
    }

    .chat-message.sent {
        align-self: flex-end;
    }

    .chat-message.received {
        align-self: flex-start;
    }

    .chat-message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        margin-right: 10px;
        object-fit: cover;
    }

    .chat-message-content {
        background-color: rgba(17, 17, 17, 0.8);
        padding: 10px 15px;
        border-radius: 15px;
        position: relative;
    }

    .chat-message.sent .chat-message-content {
        background-color: rgba(157, 78, 221, 0.3);
        border-bottom-right-radius: 5px;
    }

    .chat-message.received .chat-message-content {
        background-color: rgba(17, 17, 17, 0.8);
        border-bottom-left-radius: 5px;
    }

    .chat-message-username {
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 5px;
        color: #9d4edd;
    }

    .chat-message-text {
        font-size: 14px;
        line-height: 1.4;
        word-break: break-word;
    }

    .chat-message-time {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.5);
        margin-top: 5px;
        text-align: right;
    }

    .chat-input-container {
        display: flex;
        align-items: center;
        padding: 15px;
        background-color: rgba(17, 17, 17, 0.8);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        background-color: rgba(0, 0, 0, 0.3);
        color: white;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s ease;
    }

    .chat-input:focus {
        border-color: #9d4edd;
    }

    .chat-send-btn {
        background-color: #9d4edd;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        margin-left: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .chat-send-btn:hover {
        background-color: #8a44c8;
    }

    .chat-login-prompt {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 20px;
        text-align: center;
    }

    .chat-login-message {
        font-size: 18px;
        margin-bottom: 20px;
        color: rgba(255, 255, 255, 0.7);
    }

    .chat-login-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #9d4edd, #7b2cbf);
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chat-login-btn:hover {
        background: linear-gradient(135deg, #8a44c8, #6a24a6);
        transform: translateY(-2px);
    }

    .typing-indicator {
        display: flex;
        align-items: center;
        margin-top: 5px;
        margin-bottom: 15px;
        align-self: flex-start;
    }

    .typing-indicator span {
        height: 8px;
        width: 8px;
        margin: 0 1px;
        background-color: #9d4edd;
        display: block;
        border-radius: 50%;
        opacity: 0.4;
    }

    .typing-indicator span:nth-of-type(1) {
        animation: 1s blink infinite 0.3333s;
    }

    .typing-indicator span:nth-of-type(2) {
        animation: 1s blink infinite 0.6666s;
    }

    .typing-indicator span:nth-of-type(3) {
        animation: 1s blink infinite 0.9999s;
    }

    @keyframes blink {
        50% {
            opacity: 1;
        }
    }

    /* Modal styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal {
        background-color: rgba(17, 17, 17, 0.95);
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        padding: 2rem;
        position: relative;
        box-shadow: 0 0 20px #9d4edd, 0 0 30px #9d4edd;
        transform: scale(0.9);
        transition: transform 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .modal-overlay.active .modal {
        transform: scale(1);
    }

    .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        color: #fff;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .modal-header {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #333;
        padding-bottom: 1rem;
    }

    .modal-header img {
        width: 60px;
        height: 60px;
        margin-right: 1rem;
        box-shadow: 0 0 10px #9d4edd;
    }

    .modal-title {
        font-size: 1.8rem;
        margin: 0;
    }

    .modal-price {
        font-size: 2rem;
        color: #9d4edd;
        margin: 1rem 0;
        font-weight: bold;
    }

    .modal-description {
        margin-bottom: 1.5rem;
        line-height: 1.6;
    }

    .features-list {
        list-style: none;
        padding: 0;
        margin-bottom: 1.5rem;
    }

    .features-list li {
        padding: 0.5rem 0;
        display: flex;
        align-items: center;
    }

    .features-list li:before {
        content: "✓";
        color: #9d4edd;
        margin-right: 0.5rem;
        font-weight: bold;
    }

    .limited-tag {
        background-color: #9d4edd;
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 8px;
        font-weight: bold;
    }

    .purchase-btn {
        background: linear-gradient(135deg, #9d4edd, #7b2cbf);
        color: white;
        border: none;
        padding: 1rem 2rem;
        font-size: 1.2rem;
        border-radius: 50px;
        width: 100%;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
    }

    .purchase-btn:hover {
        background: linear-gradient(135deg, #8a44c8, #6a24a6);
        transform: translateY(-2px);
    }

    .purchase-btn.disabled {
        background: #444;
        color: #aaa;
        cursor: not-allowed;
        transform: none;
    }

    .stop-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border: 2px solid #ff5555;
        border-radius: 50%;
        position: relative;
    }

    .stop-icon:before {
        content: "";
        position: absolute;
        width: 14px;
        height: 2px;
        background-color: #ff5555;
        transform: rotate(45deg);
    }

    .stop-icon:after {
        content: "";
        position: absolute;
        width: 14px;
        height: 2px;
        background-color: #ff5555;
        transform: rotate(-45deg);
    }

    .stock-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
    }

    .stock-count {
        color: #9d4edd;
        font-weight: bold;
    }

    /* First-time purchase badge */
    .first-time-badge {
        background-color: #9d4edd;
        color: white;
        font-size: 0.8rem;
        padding: 4px 8px;
        border-radius: 10px;
        margin-left: 8px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .first-time-badge svg {
        width: 12px;
        height: 12px;
    }

    /* Login/Register Modal */
    .auth-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .auth-tab {
        flex: 1;
        text-align: center;
        padding: 10px;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.7);
        transition: all 0.3s ease;
    }

    .auth-tab.active {
        color: white;
        border-bottom: 2px solid #9d4edd;
    }

    .auth-content {
        display: none;
    }

    .auth-content.active {
        display: block;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
    }

    .form-input {
        width: 100%;
        padding: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 3px;
        background-color: rgba(0, 0, 0, 0.3);
        color: white;
        font-size: 16px;
        transition: border-color 0.3s ease;
    }

    .form-input:focus {
        border-color: #9d4edd;
        outline: none;
    }

    .auth-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #9d4edd, #7b2cbf);
        color: white;
        border: none;
        border-radius: 3px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .auth-btn:hover {
        background: linear-gradient(135deg, #8a44c8, #6a24a6);
        transform: translateY(-2px);
    }

    .auth-footer {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.5);
    }

    .auth-link {
        color: #9d4edd;
        cursor: pointer;
        text-decoration: none;
    }

    .auth-link:hover {
        text-decoration: underline;
    }

    /* Verification code styles */
    .verification-container {
        display: none;
    }

    .verification-container.active {
        display: block;
    }

    .verification-title {
        font-size: 18px;
        margin-bottom: 15px;
        text-align: center;
    }

    .verification-message {
        margin-bottom: 20px;
        text-align: center;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
    }

    .verification-email {
        font-weight: bold;
        color: #9d4edd;
    }

    .verification-code-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .verification-code-input {
        width: 40px;
        height: 50px;
        text-align: center;
        font-size: 24px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background-color: rgba(0, 0, 0, 0.3);
        color: white;
        border-radius: 3px;
    }

    .verification-code-input:focus {
        border-color: #9d4edd;
        outline: none;
    }

    .resend-code {
        text-align: center;
        margin-top: 15px;
        font-size: 14px;
    }

    .resend-btn {
        background: none;
        border: none;
        color: #9d4edd;
        cursor: pointer;
        font-size: 14px;
        text-decoration: underline;
    }

    .resend-btn:hover {
        color: #8a44c8;
    }

    .resend-timer {
        color: rgba(255, 255, 255, 0.5);
        font-size: 14px;
    }

    /* Email preview (for demo purposes) */
    .email-preview-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .email-preview-modal.active {
        opacity: 1;
        visibility: visible;
    }

    .email-preview {
        background-color: #fff;
        color: #333;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        padding: 2rem;
        position: relative;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .email-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }

    .email-logo {
        font-size: 24px;
        font-weight: bold;
        color: #9d4edd;
        margin: 0;
    }

    .email-subject {
        font-size: 18px;
        margin: 15px 0;
        color: #333;
    }

    .email-body {
        line-height: 1.6;
        color: #555;
    }

    .email-code {
        background-color: #f5f5f5;
        padding: 15px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        letter-spacing: 5px;
        margin: 20px 0;
        border-radius: 5px;
        color: #333;
    }

    .email-footer {
        margin-top: 30px;
        font-size: 12px;
        color: #999;
        text-align: center;
        border-top: 1px solid #eee;
        padding-top: 15px;
    }

    .email-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        color: #333;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .email-btn {
        display: block;
        width: 100%;
        padding: 12px;
        background-color: #9d4edd;
        color: white;
        border: none;
        border-radius: 3px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        text-align: center;
        margin-top: 20px;
    }

    /* Settings Modal */
    .settings-container {
        display: flex;
        flex-direction: column;
        width: 100%;
    }

    .settings-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .settings-tab {
        flex: 1;
        text-align: center;
        padding: 10px;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.7);
        transition: all 0.3s ease;
    }

    .settings-tab.active {
        color: white;
        border-bottom: 2px solid #9d4edd;
    }

    .settings-content {
        display: none;
    }

    .settings-content.active {
        display: block;
    }

    .profile-picture-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
    }

    .profile-picture {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #9d4edd;
        margin-bottom: 15px;
    }

    .profile-picture-upload {
        display: none;
    }

    .profile-picture-btn {
        background-color: rgba(157, 78, 221, 0.2);
        color: white;
        border: 1px solid rgba(157, 78, 221, 0.5);
        border-radius: 3px;
        padding: 8px 15px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .profile-picture-btn:hover {
        background-color: rgba(157, 78, 221, 0.3);
    }

    .settings-section {
        margin-bottom: 20px;
    }

    .settings-section-title {
        font-size: 16px;
        margin-bottom: 15px;
        color: rgba(255, 255, 255, 0.8);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 5px;
    }

    .settings-save-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #9d4edd, #7b2cbf);
        color: white;
        border: none;
        border-radius: 3px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
    }

    .settings-save-btn:hover {
        background: linear-gradient(135deg, #8a44c8, #6a24a6);
        transform: translateY(-2px);
    }

    /* PayPal Payment Modal */
    .payment-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .payment-title {
        font-size: 20px;
        margin-bottom: 20px;
        text-align: center;
    }

    .payment-description {
        margin-bottom: 20px;
        text-align: center;
        line-height: 1.6;
        color: rgba(255, 255, 255, 0.7);
    }

    .payment-options {
        display: flex;
        flex-direction: column;
        width: 100%;
        margin-bottom: 20px;
        gap: 10px;
    }

    .payment-option {
        display: flex;
        align-items: center;
        padding: 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .payment-option:hover:not(.disabled) {
        background-color: rgba(157, 78, 221, 0.1);
        border-color: #9d4edd;
    }

    .payment-option.selected:not(.disabled) {
        background-color: rgba(157, 78, 221, 0.2);
        border-color: #9d4edd;
    }

    .payment-option.disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .payment-option-icon {
        width: 40px;
        height: 40px;
        margin-right: 15px;
    }

    .payment-option-details {
        flex: 1;
    }

    .payment-option-name {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .payment-option-description {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
    }

    .payment-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #0070ba, #1546a0);
        color: white;
        border: none;
        border-radius: 3px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .payment-btn:hover {
        background: linear-gradient(135deg, #005ea6, #0d3d8d);
        transform: translateY(-2px);
    }

    .payment-btn:disabled {
        background: #444;
        color: #aaa;
        cursor: not-allowed;
        transform: none;
    }

    /* Key Display Modal */
    .key-display-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .key-display-title {
        font-size: 20px;
        margin-bottom: 20px;
        text-align: center;
    }

    .key-display-box {
        width: 100%;
        padding: 15px;
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid #9d4edd;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
        font-family: monospace;
        font-size: 18px;
        color: #9d4edd;
        word-break: break-all;
        box-shadow: 0 0 10px rgba(157, 78, 221, 0.5);
    }

    .key-display-instructions {
        margin-bottom: 20px;
        text-align: center;
        line-height: 1.6;
        color: rgba(255, 255, 255, 0.7);
    }

    .copy-key-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #9d4edd, #7b2cbf);
        color: white;
        border: none;
        border-radius: 3px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .copy-key-btn:hover {
        background: linear-gradient(135deg, #8a44c8, #6a24a6);
        transform: translateY(-2px);
    }

    /* Free Key Modal */
    .free-key-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        text-align: center;
    }

    .free-key-title {
        font-size: 24px;
        margin-bottom: 15px;
        color: #9d4edd;
    }

    .free-key-subtitle {
        font-size: 18px;
        margin-bottom: 20px;
    }

    .free-key-icon {
        font-size: 48px;
        margin-bottom: 20px;
        color: #9d4edd;
    }

    .free-key-message {
        margin-bottom: 20px;
        line-height: 1.6;
    }

    /* Loading Spinner */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .title {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            margin-top: 2rem;
        }
        
        .search-cart-container {
            flex-direction: column;
            gap: 10px;
        }
        
        .cart-container {
            align-self: flex-end;
        }
        
        .wishlist-dropdown {
            width: 280px;
            right: -10px;
        }
        
        .keys-container {
            flex-direction: column;
            gap: 2rem;
        }
        
        .key-image {
            width: 100px;
            height: 100px;
        }
        
        .modal-title {
            font-size: 1.5rem;
        }
        
        .nav-tabs {
            flex-wrap: wrap;
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .title {
            font-size: 2.5rem;
        }
        
        .key-image {
            width: 80px;
            height: 80px;
        }
        
        .key-label {
            font-size: 1rem;
        }
        
        .modal {
            padding: 1.5rem;
        }
        
        .modal-price {
            font-size: 1.8rem;
        }
        
        .wishlist-dropdown {
            width: 250px;
        }
        
        .tab {
            padding: 8px 15px;
            font-size: 14px;
        }

        .verification-code-input {
            width: 35px;
            height: 45px;
            font-size: 20px;
        }
    }
</style>
</head>
<body>
<!-- Loading Screen -->
<div class="loading-screen" id="loading-screen">
    <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/IMG_5677-dBJXi77lkTpRdc9gxyW6ckCJhDzMxU.png" alt="Nebula Logo" class="loading-logo">
    <div class="loading-text">Loading Nebula...</div>
    <div class="loading-progress">
        <div class="loading-progress-bar" id="loading-progress-bar"></div>
    </div>
</div>

<!-- Animated Background -->
<div class="background">
    <div class="snow-container" id="snow-container"></div>
</div>

<div class="container">
    <h1 class="title">Nebula</h1>
    
    <!-- Navigation and Profile -->
    <div class="nav-container">
        <div class="nav-tabs">
            <button class="tab active" data-tab="keys">Keys</button>
            <button class="tab" data-tab="executor">Executor</button>
            <button class="tab" data-tab="support">Support</button>
            <button class="tab" data-tab="chat">AI Chat</button>
            <div class="profile-container">
                <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/user-icon-1024x1024-unb6q333-0jVFdZBhNPWl1hc5fLXaDNDkk8qerb.png" alt="Profile" class="profile-icon" id="profile-icon" onclick="toggleProfile()">
                <div class="profile-dropdown" id="profile-dropdown">
                    <div id="logged-out-content">
                        <div class="profile-dropdown-item" onclick="openAuthModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                                <polyline points="10 17 15 12 10 7"></polyline>
                                <line x1="15" y1="12" x2="3" y2="12"></line>
                            </svg>
                            Login / Register
                        </div>
                    </div>
                    <div id="logged-in-content" style="display: none;">
                        <div class="profile-dropdown-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <span id="username-display">Username</span>
                        </div>
                        <div class="profile-dropdown-divider"></div>
                        <div class="profile-dropdown-item" onclick="logout()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            Logout
                        </div>
                        <div class="profile-dropdown-divider"></div>
                        <div class="profile-dropdown-item" onclick="openSettingsModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            Settings
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab Contents -->
    <div class="tabs-container">
        <!-- Search and Cart Bar -->
        <div class="search-cart-container">
            <div class="search-container">
                <input type="text" class="search-input" id="search-input" placeholder="Search products..." oninput="searchProducts()">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <div class="search-results" id="search-results"></div>
            </div>
            
            <div class="cart-container">
                <div class="cart-icon" onclick="toggleWishlist()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 20l-5.447-2.724A1 1 0 0 1 3 16.382V5.618a1 1 0 0 1 1.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0 0 21 18.382V7.618a1 1 0 0 0-.553-.894L15 4m0 13V4"></path>
                    </svg>
                </div>
                <div class="cart-count" id="wishlist-count">0</div>
                
                <!-- Wishlist Dropdown -->
                <div class="wishlist-dropdown" id="wishlist-dropdown">
                    <div class="wishlist-header">
                        <h3 class="wishlist-title">Wishlist</h3>
                        <button class="wishlist-close" onclick="toggleWishlist()">×</button>
                    </div>
                    <div class="wishlist-items" id="wishlist-items">
                        <div class="wishlist-empty" id="wishlist-empty">Your wishlist is empty</div>
                        <!-- Wishlist items will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content active" id="keys-tab">
            <div class="keys-container">
                <div class="key-item" onclick="openModal('week')">
                    <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/key-uKWnAejMgrE0GvlAwDdeipPomr3i7b.png" alt="  alt="1 Week Key" class="key-image">
                    <div class="key-label">1 Week Key</div>
                    <button class="add-to-wishlist" onclick="addToWishlist(event, 'week')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="key-item" onclick="openModal('month')">
                    <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/key-uKWnAejMgrE0GvlAwDdeipPomr3i7b.png" alt="1 Month Key" class="key-image">
                    <div class="key-label">1 Month Key</div>
                    <button class="add-to-wishlist" onclick="addToWishlist(event, 'month')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="key-item" onclick="openModal('sixmonth')">
                    <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/key-uKWnAejMgrE0GvlAwDdeipPomr3i7b.png" alt="6 Months Key" class="key-image">
                    <div class="key-label">6 Months Key</div>
                    <button class="add-to-wishlist" onclick="addToWishlist(event, 'sixmonth')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="executor-tab">
            <div class="executor-container">
                <div class="not-available-icon">⚠️</div>
                <div class="not-available-message">
                    Not Available at the Moment<br>
                    <span style="font-size: 16px; opacity: 0.7; margin-top: 10px; display: block;">
                        Our executor products are currently under maintenance.<br>
                        Please check back later for updates.
                    </span>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="support-tab">
            <div class="support-container">
                <h2 class="support-title">Support & Community</h2>
                <p class="support-description">
                    Need help with Nebula? Join our Discord community for instant support, updates, and to connect with other users. Our team is available 24/7 to assist you with any questions or issues.
                </p>
                
                <a href="https://discord.gg/nebulav" target="_blank" class="discord-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189Z"/>
                    </svg>
                    Join our Discord Server
                </a>
            </div>
        </div>
        
        <div class="tab-content" id="chat-tab">
            <div class="chat-container" id="chat-container">
                <!-- AI Chat content will be dynamically loaded based on login status -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Overlays -->
<div class="modal-overlay" id="modal-week">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('week')">×</button>
        <div class="modal-header">
            <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/key-uKWnAejMgrE0GvlAwDdeipPomr3i7b.png" alt="1 Week Key">
            <h2 class="modal-title">Nebula 1 Week Access Key</h2>
        </div>
        <div class="modal-price">$2.00</div>
        <div class="stock-info">
            <span>Stock:</span>
            <span class="stock-count" id="week-stock-count">Loading...</span>
        </div>
        <div class="modal-description">
            Get full access to Nebula for one week. Perfect for trying out all premium features.
        </div>
        <ul class="features-list">
            <li>Full access to all Nebula features</li>
            <li>24/7 customer support</li>
            <li>1 month extra Bonus <span class="limited-tag">LIMITED</span></li>
            <li>First-time purchase bonus <span class="first-time-badge">FREE</span></li>
        </ul>
        <button class="purchase-btn" id="week-purchase-btn" onclick="startPurchase('week')">
            Purchase Now
        </button>
    </div>
</div>

<div class="modal-overlay" id="modal-month">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('month')">×</button>
        <div class="modal-header">
            <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/key-uKWnAejMgrE0GvlAwDdeipPomr3i7b.png" alt="1 Month Key">
            <h2 class="modal-title">Nebula 1 Month Access Key</h2>
        </div>
        <div class="modal-price">$5.00</div>
        <div class="stock-info">
            <span>Stock:</span>
            <span class="stock-count" id="month-stock-count">109 keys available</span>
        </div>
        <div class="modal-description">
            Our most popular option. Get full access to Nebula for a full month at a great value.
        </div>
        <ul class="features-list">
            <li>Full access to all Nebula features</li>
            <li>Priority customer support</li>
            <li>1 month extra Bonus <span class="limited-tag">LIMITED</span></li>
            <li>First-time purchase bonus <span class="first-time-badge">FREE</span></li>
            <li>Access to exclusive monthly content</li>
        </ul>
        <button class="purchase-btn" id="month-purchase-btn" onclick="startPurchase('month')">
            Purchase Now
        </button>
    </div>
</div>

<div class="modal-overlay" id="modal-sixmonth">
    <div class="modal">
        <button class="modal-close" onclick="closeModal('sixmonth')">×</button>
        <div class="modal-header">
            <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/key-uKWnAejMgrE0GvlAwDdeipPomr3i7b.png" alt="6 Months Key">
            <h2 class="modal-title">Nebula 6 Months Access Key</h2>
        </div>
        <div class="modal-price">$10.00</div>
        <div class="stock-info">
            <span>Stock:</span>
            <span class="stock-count">Out of Stock</span>
        </div>
        <div class="modal-description">
            Our best value package. Get full access to Nebula for six months with premium benefits.
        </div>
        <ul class="features-list">
            <li>Full access to all Nebula features</li>
            <li>VIP customer support</li>
            <li>1 month extra Bonus <span class="limited-tag">LIMITED</span></li>
            <li>First-time purchase bonus <span class="first-time-badge">FREE</span></li>
            <li>Access to exclusive monthly content</li>
            <li>Early access to new features</li>
            <li>25% discount on next renewal</li>
        </ul>
        <button class="purchase-btn disabled">
            <span class="stop-icon"></span>
            Out of Stock
        </button>
    </div>
</div>

<!-- Free Key Modal for First-Time Users -->
<div class="modal-overlay" id="free-key-modal">
    <div class="modal">
        <button class="modal-close" onclick="closeFreeKeyModal()">×</button>
        <div class="free-key-container">
            <div class="free-key-icon">🎁</div>
            <h2 class="free-key-title">Welcome to Nebula!</h2>
            <h3 class="free-key-subtitle">Your Free Key is Ready</h3>
            <p class="free-key-message">
                As a first-time user, you've received a free key to try Nebula!
                This key gives you 3 days of full access to all our premium features.
            </p>
            <div class="key-display-box" id="free-key-display">
                Generating your free key...
            </div>
            <p class="key-display-instructions">
                Please copy this key and keep it in a safe place. You will need it to activate your Nebula subscription.
            </p>
            <button class="copy-key-btn" onclick="copyFreeKeyToClipboard()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Copy Key
            </button>
        </div>
    </div>
</div>

<!-- Login/Register Modal -->
<div class="modal-overlay" id="auth-modal">
    <div class="modal">
        <button class="modal-close" onclick="closeAuthModal()">×</button>
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
            <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
        </div>
        
        <div class="auth-content active" id="login-content">
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-input" id="login-username">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="login-password">
            </div>
            <button class="auth-btn" onclick="sendVerificationCode('login')">Login</button>
            <div class="auth-footer">
                Don't have an account? <span class="auth-link" onclick="switchAuthTab('register')">Register</span>
            </div>
        </div>
        
        <div class="auth-content" id="register-content">
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-input" id="register-username">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="register-email">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="register-password">
            </div>
            <div class="form-group">
                <label class="form-label">Confirm Password</label>
                <input type="password" class="form-input" id="register-confirm-password">
            </div>
            <button class="auth-btn" onclick="sendVerificationCode('register')">Register</button>
            <div class="auth-footer">
                Already have an account? <span class="auth-link" onclick="switchAuthTab('login')">Login</span>
            </div>
        </div>
        
        <!-- Verification Code Section -->
        <div class="verification-container" id="verification-container">
            <h3 class="verification-title">Email Verification</h3>
            <p class="verification-message">We've sent a verification code to <span class="verification-email" id="verification-email">your email</span>. Please enter the code below to continue.</p>
            
            <div class="verification-code-container">
                <input type="text" maxlength="1" class="verification-code-input" id="code-1" onkeyup="moveToNext(this, 'code-2')">
                <input type="text" maxlength="1" class="verification-code-input" id="code-2" onkeyup="moveToNext(this, 'code-3')" onkeydown="moveToPrev(this, 'code-1')">
                <input type="text" maxlength="1" class="verification-code-input" id="code-3" onkeyup="moveToNext(this, 'code-4')" onkeydown="moveToPrev(this, 'code-2')">
                <input type="text" maxlength="1" class="verification-code-input" id="code-4" onkeyup="moveToNext(this, 'code-5')" onkeydown="moveToPrev(this, 'code-3')">
                <input type="text" maxlength="1" class="verification-code-input" id="code-5" onkeyup="moveToNext(this, 'code-6')" onkeydown="moveToPrev(this, 'code-4')">
                <input type="text" maxlength="1" class="verification-code-input" id="code-6" onkeydown="moveToPrev(this, 'code-5')">
            </div>
            
            <button class="auth-btn" onclick="verifyCode()">Verify</button>
            
            <div class="resend-code">
                <span id="resend-timer" class="resend-timer">Resend code in 60s</span>
                <button id="resend-btn" class="resend-btn" style="display: none;" onclick="resendCode()">Resend Code</button>
            </div>
        </div>
    </div>
</div>

<!-- Email Preview Modal (for demo purposes) -->
<div class="email-preview-modal" id="email-preview-modal">
    <div class="email-preview">
        <button class="email-close" onclick="closeEmailPreview()">×</button>
        <div class="email-header">
            <h3 class="email-logo">Nebula</h3>
            <h4 class="email-subject">Your Verification Code</h4>
        </div>
        <div class="email-body">
            <p>Hello <span id="email-name">there</span>,</p>
            <p>Thank you for registering with Nebula. To complete your registration, please use the verification code below:</p>
            <div class="email-code" id="email-code">123456</div>
            <p>This code will expire in 10 minutes. If you did not request this code, please ignore this email.</p>
            <p>Best regards,<br>The Nebula Team</p>
        </div>
        <div class="email-footer">
            <p>© 2025 Nebula. All rights reserved.</p>
            <p>This is an automated message, please do not reply.</p>
        </div>
        <button class="email-btn" onclick="copyCodeAndClose()">Copy Code & Close</button>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal">
    <div class="modal">
        <button class="modal-close" onclick="closeSettingsModal()">×</button>
        <h2 class="modal-title">Account Settings</h2>
        
        <div class="settings-container">
            <div class="settings-tabs">
                <div class="settings-tab active" onclick="switchSettingsTab('profile')">Profile</div>
                <div class="settings-tab" onclick="switchSettingsTab('account')">Account</div>
            </div>
            
            <div class="settings-content active" id="profile-settings">
                <div class="profile-picture-container">
                    <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/user-icon-1024x1024-unb6q333-0jVFdZBhNPWl1hc5fLXaDNDkk8qerb.png" alt="Profile Picture" class="profile-picture" id="settings-profile-picture">
                    <input type="file" id="profile-picture-upload" class="profile-picture-upload" accept="image/*" onchange="previewProfilePicture(this)">
                    <label for="profile-picture-upload" class="profile-picture-btn">Change Profile Picture</label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="settings-username">
                </div>
                
                <button class="settings-save-btn" onclick="saveProfileSettings()">Save Changes</button>
            </div>
            
            <div class="settings-content" id="account-settings">
                <div class="settings-section">
                    <h3 class="settings-section-title">Email Address</h3>
                    <div class="form-group">
                        <label class="form-label">Current Email</label>
                        <input type="email" class="form-input" id="settings-current-email" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Email</label>
                        <input type="email" class="form-input" id="settings-new-email">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-section-title">Change Password</h3>
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" class="form-input" id="settings-current-password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-input" id="settings-new-password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-input" id="settings-confirm-password">
                    </div>
                </div>
                
                <button class="settings-save-btn" onclick="saveAccountSettings()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- PayPal Payment Modal -->
<div class="modal-overlay" id="payment-modal">
    <div class="modal">
        <button class="modal-close" onclick="closePaymentModal()">×</button>
        <h2 class="modal-title">Complete Your Purchase</h2>
        
        <div class="payment-container">
            <p class="payment-description">
                You are about to purchase a <span id="payment-product-name">1 Week Key</span> for <span id="payment-product-price">$2.00</span>. Please select your payment method.
            </p>
            
            <div class="payment-options">
                <div class="payment-option selected" onclick="selectPaymentMethod('paypal')">
                    <img src="https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_37x23.jpg" alt="PayPal" class="payment-option-icon">
                    <div class="payment-option-details">
                        <div class="payment-option-name">PayPal</div>
                        <div class="payment-option-description">Pay securely with your PayPal account</div>
                    </div>
                </div>
                
                <div class="payment-option disabled" onclick="alert('Card payment is currently not available')">
                    <img src="https://cdn-icons-png.flaticon.com/512/179/179457.png" alt="Credit Card" class="payment-option-icon">
                    <div class="payment-option-details">
                        <div class="payment-option-name">
                            Credit/Debit Card
                            <span class="stop-icon" style="width: 16px; height: 16px;"></span>
                        </div>
                        <div class="payment-option-description">Currently not available</div>
                    </div>
                </div>
            </div>
            
            <button class="payment-btn" id="complete-payment-btn" onclick="completePayment()">
                <span id="payment-btn-text">Proceed to PayPal</span>
            </button>
        </div>
    </div>
</div>

<!-- Key Display Modal -->
<div class="modal-overlay" id="key-display-modal">
    <div class="modal">
        <button class="modal-close" onclick="closeKeyDisplayModal()">×</button>
        <h2 class="modal-title">Your Nebula Key</h2>
        
        <div class="key-display-container">
            <p class="key-display-title">
                Thank you for your purchase! Here is your Nebula key:
            </p>
            
            <div class="key-display-box" id="purchased-key">
                Loading your key...
            </div>
            
            <p class="key-display-instructions">
                Please copy this key and keep it in a safe place. You will need it to activate your Nebula subscription.
            </p>
            
            <button class="copy-key-btn" onclick="copyKeyToClipboard()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Copy Key
            </button>
        </div>
    </div>
</div>

<script>
    // Loading screen functionality
    function simulateLoading() {
        const progressBar = document.getElementById('loading-progress-bar');
        let progress = 0;
        
        // Set a fixed duration of 3 seconds for the loading screen
        const duration = 3000; // 3 seconds
        const interval = 50; // Update every 50ms
        const steps = duration / interval;
        const increment = 100 / steps;
        
        const loadingInterval = setInterval(() => {
            progress += increment;
            if (progress >= 100) {
                progress = 100;
                clearInterval(loadingInterval);
                
                // Hide loading screen after exactly 3 seconds
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                }, 500);
            }
            progressBar.style.width = `${progress}%`;
        }, interval);
    }

    // Create falling snow particles
    function createSnow() {
        const container = document.getElementById('snow-container');
        const count = 150;
        
        for (let i = 0; i < count; i++) {
            createSnowflake(container);
        }
    }
    
    function createSnowflake(container) {
        const snowflake = document.createElement('div');
        const size = Math.random() * 3 + 1; // Size between 1-4px
        const startPositionX = Math.random() * 100; // Random X position
        const duration = Math.random() * 10 + 10; // Fall duration between 10-20s
        const delay = Math.random() * 10; // Random delay for natural effect
        
        snowflake.className = 'snowflake';
        snowflake.style.width = `${size}px`;
        snowflake.style.height = `${size}px`;
        snowflake.style.left = `${startPositionX}%`;
        snowflake.style.top = '0';
        snowflake.style.animation = `fall ${duration}s linear ${delay}s infinite`;
        
        container.appendChild(snowflake);
    }
    
    // Tab functionality
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show the tab content corresponding to the clicked tab
            const tabId = this.getAttribute('data-tab');
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // Initialize chat if chat tab is selected
            if (tabId === 'chat') {
                initializeAIChat();
            }
        });
    });
    
    // Modal functions
    function openModal(type) {
        document.getElementById('modal-' + type).classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
    }
    
    function closeModal(type) {
        document.getElementById('modal-' + type).classList.remove('active');
        document.body.style.overflow = 'auto'; // Re-enable scrolling
    }
    
    // Close modal when clicking outside of it
    document.queryS  // Re-enable scrolling
    }
    
    // Close modal when clicking outside of it
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        });
    });
    
    // Profile dropdown
    function toggleProfile() {
        document.getElementById('profile-dropdown').classList.toggle('active');
    }
    
    // Close profile dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const profileDropdown = document.getElementById('profile-dropdown');
        const profileIcon = document.querySelector('.profile-icon');
        
        if (!profileDropdown.contains(e.target) && e.target !== profileIcon) {
            profileDropdown.classList.remove('active');
        }
    });
    
    // Database simulation for user data
    const dbName = 'nebulaDB';
    let db;
    
    // Initialize IndexedDB
    function initDB() {
        const request = indexedDB.open(dbName, 1);
        
        request.onerror = function(event) {
            console.error("Database error: " + event.target.errorCode);
        };
        
        request.onupgradeneeded = function(event) {
            db = event.target.result;
            
            // Create users object store
            if (!db.objectStoreNames.contains('users')) {
                const usersStore = db.createObjectStore('users', { keyPath: 'username' });
                usersStore.createIndex('email', 'email', { unique: true });
                usersStore.createIndex('ip', 'ip', { unique: false });
            }
            
            // Create chat messages object store
            if (!db.objectStoreNames.contains('chatMessages')) {
                const chatStore = db.createObjectStore('chatMessages', { keyPath: 'id', autoIncrement: true });
                chatStore.createIndex('username', 'username', { unique: false });
            }
            
            // Create keys object store
            if (!db.objectStoreNames.contains('keys')) {
                const keysStore = db.createObjectStore('keys', { keyPath: 'id', autoIncrement: true });
                keysStore.createIndex('type', 'type', { unique: false });
                keysStore.createIndex('username', 'username', { unique: false });
            }
            
            // Create IP registry for free keys
            if (!db.objectStoreNames.contains('ipRegistry')) {
                const ipStore = db.createObjectStore('ipRegistry', { keyPath: 'ip' });
                ipStore.createIndex('hasReceivedFreeKey', 'hasReceivedFreeKey', { unique: false });
            }
        };
        
        request.onsuccess = function(event) {
            db = event.target.result;
            console.log("Database initialized successfully");
            
            // Check login status after DB is initialized
            checkLoginStatus();
            
            // Initialize key stock
            initializeKeyStock();
        };
    }
    
    // Get user's IP address
    async function getUserIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        } catch (error) {
            console.error('Error getting IP:', error);
            return 'unknown';
        }
    }
    
    // Check if IP has already received a free key
    async function hasIPReceivedFreeKey(ip) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['ipRegistry'], 'readonly');
            const store = transaction.objectStore('ipRegistry');
            const request = store.get(ip);
            
            request.onsuccess = function(event) {
                const record = event.target.result;
                resolve(record && record.hasReceivedFreeKey);
            };
            
            request.onerror = function(event) {
                reject(event.target.error);
            };
        });
    }
    
    // Register IP as having received a free key
    async function registerIPForFreeKey(ip) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['ipRegistry'], 'readwrite');
            const store = transaction.objectStore('ipRegistry');
            const request = store.put({ ip, hasReceivedFreeKey: true });
            
            request.onsuccess = function() {
                resolve();
            };
            
            request.onerror = function(event) {
                reject(event.target.error);
            };
        });
    }
    
    // Auth modal functions
    function openAuthModal() {
        document.getElementById('auth-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Reset verification container
        document.getElementById('verification-container').classList.remove('active');
        document.getElementById('login-content').classList.add('active');
        document.querySelector('.auth-tab:first-child').classList.add('active');
    }
    
    function closeAuthModal() {
        document.getElementById('auth-modal').classList.remove('active');
        document.body.style.overflow = 'auto';
        
        // Reset verification container
        document.getElementById('verification-container').classList.remove('active');
        document.getElementById('login-content').classList.add('active');
        document.getElementById('register-content').classList.remove('active');
    }
    
    function switchAuthTab(tab) {
        // Remove active class from all tabs and contents
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.auth-content').forEach(c => c.classList.remove('active'));
        document.getElementById('verification-container').classList.remove('active');
        
        // Add active class to selected tab and content
        if (tab === 'login') {
            document.querySelector('.auth-tab:first-child').classList.add('active');
            document.getElementById('login-content').classList.add('active');
        } else {
            document.querySelector('.auth-tab:last-child').classList.add('active');
            document.getElementById('register-content').classList.add('active');
        }
    }
    
    // Settings modal functions
    function openSettingsModal() {
        // Populate settings fields with current user data
        if (currentUser) {
            document.getElementById('settings-username').value = currentUser.username;
            document.getElementById('settings-current-email').value = currentUser.email;
            
            // Set profile picture if user has one
            if (currentUser.profilePicture) {
                document.getElementById('settings-profile-picture').src = currentUser.profilePicture;
            }
        }
        
        document.getElementById('settings-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function closeSettingsModal() {
        document.getElementById('settings-modal').classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    function switchSettingsTab(tab) {
        // Remove active class from all tabs and contents
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.settings-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to selected tab and content
        if (tab === 'profile') {
            document.querySelector('.settings-tab:first-child').classList.add('active');
            document.getElementById('profile-settings').classList.add('active');
        } else {
            document.querySelector('.settings-tab:last-child').classList.add('active');
            document.getElementById('account-settings').classList.add('active');
        }
    }
    
    function previewProfilePicture(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                document.getElementById('settings-profile-picture').src = e.target.result;
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function saveProfileSettings() {
        if (!currentUser) return;
        
        const newUsername = document.getElementById('settings-username').value;
        const profilePicture = document.getElementById('settings-profile-picture').src;
        
        if (!newUsername) {
            alert('Username cannot be empty');
            return;
        }
        
        // Check if username is already taken by another user
        const transaction = db.transaction(['users'], 'readonly');
        const store = transaction.objectStore('users');
        const request = store.get(newUsername);
        
        request.onsuccess = function(event) {
            const existingUser = event.target.result;
            
            if (existingUser && existingUser.username !== currentUser.username) {
                alert('Username already taken');
                return;
            }
            
            // Update user in database
            const updateTransaction = db.transaction(['users'], 'readwrite');
            const updateStore = updateTransaction.objectStore('users');
            
            // If username is changed, we need to delete the old record and create a new one
            if (newUsername !== currentUser.username) {
                updateStore.delete(currentUser.username);
                
                // Update current user object
                const updatedUser = {
                    ...currentUser,
                    username: newUsername,
                    profilePicture: profilePicture
                };
                
                updateStore.add(updatedUser);
                currentUser = updatedUser;
            } else {
                // Just update the profile picture
                currentUser.profilePicture = profilePicture;
                updateStore.put(currentUser);
            }
            
            // Update UI
            document.getElementById('username-display').textContent = newUsername;
            document.getElementById('profile-icon').src = profilePicture;
            
            alert('Profile settings saved successfully');
            closeSettingsModal();
        };
    }
    
    function saveAccountSettings() {
        if (!currentUser) return;
        
        const newEmail = document.getElementById('settings-new-email').value;
        const currentPassword = document.getElementById('settings-current-password').value;
        const newPassword = document.getElementById('settings-new-password').value;
        const confirmPassword = document.getElementById('settings-confirm-password').value;
        
        // Get user from database
        const transaction = db.transaction(['users'], 'readonly');
        const store = transaction.objectStore('users');
        const request = store.get(currentUser.username);
        
        request.onsuccess = function(event) {
            const user = event.target.result;
            
            if (!user) {
                alert('User not found');
                return;
            }
            
            // Check if current password is correct
            if (currentPassword && currentPassword !== user.password) {
                alert('Current password is incorrect');
                return;
            }
            
            // Update user object
            let updatedUser = { ...user };
            
            // Update email if provided
            if (newEmail && newEmail !== user.email) {
                updatedUser.email = newEmail;
                document.getElementById('settings-current-email').value = newEmail;
                document.getElementById('settings-new-email').value = '';
            }
            
            // Update password if provided
            if (newPassword) {
                if (newPassword !== confirmPassword) {
                    alert('New passwords do not match');
                    return;
                }
                
                updatedUser.password = newPassword;
                document.getElementById('settings-current-password').value = '';
                document.getElementById('settings-new-password').value = '';
                document.getElementById('settings-confirm-password').value = '';
            }
            
            // Save changes to database
            const updateTransaction = db.transaction(['users'], 'readwrite');
            const updateStore = updateTransaction.objectStore('users');
            updateStore.put(updatedUser);
            
            // Update current user
            currentUser = {
                username: updatedUser.username,
                email: updatedUser.email,
                profilePicture: updatedUser.profilePicture,
                hasMadePurchase: updatedUser.hasMadePurchase || false
            };
            
            alert('Account settings saved successfully');
        };
    }
    
    // Email preview functions
    function openEmailPreview(name, email, code) {
        document.getElementById('email-name').textContent = name || 'there';
        document.getElementById('email-code').textContent = code;
        document.getElementById('email-preview-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function closeEmailPreview() {
        document.getElementById('email-preview-modal').classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    function copyCodeAndClose() {
        const code = document.getElementById('email-code').textContent;
        
        // Fill in verification inputs
        const inputs = document.querySelectorAll('.verification-code-input');
        for (let i = 0; i < inputs.length; i++) {
            inputs[i].value = code[i] || '';
        }
        
        closeEmailPreview();
    }
    
    // Search functionality
    function searchProducts() {
        const searchInput = document.getElementById('search-input').value.toLowerCase();
        const searchResults = document.getElementById('search-results');
        
        // Clear previous results
        searchResults.innerHTML = '';
        
        if (searchInput.length < 1) {
            searchResults.classList.remove('active');
            return;
        }
        
        // Filter products based on search input
        const filteredProducts = Object.values(products).filter(product => 
            product.name.toLowerCase().includes(searchInput)
        );
        
        if (filteredProducts.length === 0) {
            searchResults.innerHTML = '<div class="search-result-item">No products found</div>';
        } else {
            filteredProducts.forEach(product => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.onclick = function() {
                    openModal(product.id);
                    searchResults.classList.remove('active');
                    document.getElementById('search-input').value = '';
                };
                
                resultItem.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="search-result-image">
                    <div class="search-result-details">
                        <h4 class="search-result-name">${product.name}</h4>
                        <p class="search-result-price">${product.price}</p>
                    </div>
                `;
                
                searchResults.appendChild(resultItem);
            });
        }
        
        searchResults.classList.add('active');
    }
    
    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        const searchResults = document.getElementById('search-results');
        const searchInput = document.getElementById('search-input');
        
        if (!searchResults.contains(e.target) && e.target !== searchInput) {
            searchResults.classList.remove('active');
        }
    });
    
    // Verification code functionality
    let verificationMode = '';
    let verificationCode = '';
    let resendTimer;
    let pendingUser = null;
    
    async function sendVerificationCode(mode) {
        verificationMode = mode;
        
        if (mode === 'login') {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                alert('Please fill in all fields');
                return;
            }
            
            // Check if user exists in database
            const transaction = db.transaction(['users'], 'readonly');
            const store = transaction.objectStore('users');
            const request = store.get(username);
            
            request.onsuccess = function(event) {
                const user = event.target.result;
                
                if (!user || user.password !== password) {
                    alert('Invalid username or password');
                    return;
                }
                
                pendingUser = {
                    username: user.username,
                    email: user.email,
                    profilePicture: user.profilePicture,
                    hasMadePurchase: user.hasMadePurchase || false,
                    ip: user.ip
                };
                
                // Generate verification code
                verificationCode = generateVerificationCode();
                
                // Show verification container
                document.getElementById('login-content').classList.remove('active');
                document.getElementById('register-content').classList.remove('active');
                document.getElementById('verification-container').classList.add('active');
                
                // Update verification email display
                document.getElementById('verification-email').textContent = user.email;
                
                // Start resend timer
                startResendTimer();
                
                // In a real implementation, this would send an email to the user
                // For demo purposes, we'll show the email preview
                openEmailPreview(user.username, user.email, verificationCode);
                
                // Focus on first input
                document.getElementById('code-1').focus();
            };
        } else {
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            
            if (!username || !email || !password || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            // Check if username already exists
            const transaction = db.transaction(['users'], 'readonly');
            const store = transaction.objectStore('users');
            const request = store.get(username);
            
            request.onsuccess = async function(event) {
                const existingUser = event.target.result;
                
                if (existingUser) {
                    alert('Username already exists');
                    return;
                }
                
                // Get user's IP address
                const ip = await getUserIP();
                
                pendingUser = {
                    username,
                    email,
                    password,
                    wishlist: [],
                    hasMadePurchase: false,
                    profilePicture: 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/user-icon-1024x1024-unb6q333-0jVFdZBhNPWl1hc5fLXaDNDkk8qerb.png',
                    ip
                };
                
                // Generate verification code
                verificationCode = generateVerificationCode();
                
                // Show verification container
                document.getElementById('login-content').classList.remove('active');
                document.getElementById('register-content').classList.remove('active');
                document.getElementById('verification-container').classList.add('active');
                
                // Update verification email display
                document.getElementById('verification-email').textContent = email;
                
                // Start resend timer
                startResendTimer();
                
                // In a real implementation, this would send an email to the user
                // For demo purposes, we'll show the email preview
                openEmailPreview(username, email, verificationCode);
                
                // Focus on first input
                document.getElementById('code-1').focus();
            };
        }
    }
    
    function generateVerificationCode() {
        return Math.floor(100000 + Math.random() * 900000).toString();
    }
    
    function startResendTimer() {
        let seconds = 60;
        const timerElement = document.getElementById('resend-timer');
        const resendButton = document.getElementById('resend-btn');
        
        timerElement.style.display = 'inline-block';
        resendButton.style.display = 'none';
        
        clearInterval(resendTimer);
        resendTimer = setInterval(() => {
            seconds--;
            timerElement.textContent = `Resend code in ${seconds}s`;
            
            if (seconds <= 0) {
                clearInterval(resendTimer);
                timerElement.style.display = 'none';
                resendButton.style.display = 'inline-block';
            }
        }, 1000);
    }
    
    function resendCode() {
        // Generate new verification code
        verificationCode = generateVerificationCode();
        
        // Reset inputs
        document.querySelectorAll('.verification-code-input').forEach(input => {
            input.value = '';
        });
        
        // Start resend timer again
        startResendTimer();
        
        // In a real implementation, this would send a new email to the user
        // For demo purposes, we'll show the email preview again
        openEmailPreview(pendingUser.username, pendingUser.email, verificationCode);
        
        // Focus on first input
        document.getElementById('code-1').focus();
    }
    
    async function verifyCode() {
        const enteredCode = 
            document.getElementById('code-1').value +
            document.getElementById('code-2').value +
            document.getElementById('code-3').value +
            document.getElementById('code-4').value +
            document.getElementById('code-5').value +
            document.getElementById('code-6').value;
        
        if (enteredCode === verificationCode) {
            if (verificationMode === 'login') {
                // Login successful
                currentUser = pendingUser;
                isLoggedIn = true;
                
                // Update UI
                updateUIForLoggedInUser();
                closeAuthModal();
                
                // Load user's wishlist
                loadUserWishlist();
                
                // Refresh chat if on chat tab
                if (document.getElementById('chat-tab').classList.contains('active')) {
                    initializeAIChat();
                }
            } else {
                // Registration successful
                const transaction = db.transaction(['users'], 'readwrite');
                const store = transaction.objectStore('users');
                store.add(pendingUser);
                
                // Auto login after registration
                currentUser = {
                    username: pendingUser.username,
                    email: pendingUser.email,
                    profilePicture: pendingUser.profilePicture,
                    hasMadePurchase: false,
                    ip: pendingUser.ip
                };
                
                isLoggedIn = true;
                
                // Update UI
                updateUIForLoggedInUser();
                closeAuthModal();
                
                // Check if this IP has already received a free key
                const ip = currentUser.ip;
                const hasReceived = await hasIPReceivedFreeKey(ip);
                
                if (!hasReceived && currentUser.email !== 'Fakemail2ezz@gmail.com') {
                    // Show free key modal for new users
                    setTimeout(() => {
                        showFreeKeyModal();
                        // Register IP as having received a free key
                        registerIPForFreeKey(ip);
                    }, 1000);
                } else if (currentUser.email === 'Fakemail2ezz@gmail.com') {
                    // Special user always gets a free key
                    setTimeout(() => {
                        showFreeKeyModal();
                    }, 1000);
                }
                
                // Refresh chat if on chat tab
                if (document.getElementById('chat-tab').classList.contains('active')) {
                    initializeAIChat();
                }
            }
            
            alert('Verification successful!');
        } else {
            alert('Invalid verification code. Please try again.');
        }
    }
    
    function moveToNext(currentInput, nextInputId) {
        if (currentInput.value.length === parseInt(currentInput.getAttribute('maxlength'))) {
            document.getElementById(nextInputId)?.focus();
        }
    }
    
    function moveToPrev(currentInput, prevInputId) {
        if (event.key === 'Backspace' && currentInput.value.length === 0) {
            document.getElementById(prevInputId)?.focus();
        }
    }
    
    // Free key functionality
    function showFreeKeyModal() {
        // Generate a free key
        const freeKey = generateFreeKey();
        document.getElementById('free-key-display').textContent = freeKey;
        
        // Show the modal
        document.getElementById('free-key-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Save the key to the database
        const transaction = db.transaction(['keys'], 'readwrite');
        const store = transaction.objectStore('keys');
        store.add({
            key: freeKey,
            type: 'free',
            username: currentUser.username,
            date: new Date().toISOString()
        });
    }
    
    function closeFreeKeyModal() {
        document.getElementById('free-key-modal').classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    function generateFreeKey() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let key = 'NEBULA-FREE-';
        for (let i = 0; i < 16; i++) {
            if (i > 0 && i % 4 === 0) key += '-';
            key += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return key;
    }
    
    function copyFreeKeyToClipboard() {
        const keyText = document.getElementById('free-key-display').textContent;
        navigator.clipboard.writeText(keyText)
            .then(() => {
                alert('Free key copied to clipboard!');
            })
            .catch(err => {
                console.error('Failed to copy key: ', err);
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = keyText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Free key copied to clipboard!');
            });
    }
    
    // User authentication
    let isLoggedIn = false;
    let currentUser = null;
    
    // Check if user is already logged in
    function checkLoginStatus() {
        const transaction = db.transaction(['users'], 'readonly');
        const store = transaction.objectStore('users');
        const request = store.openCursor();
        
        request.onsuccess = function(event) {
            const cursor = event.target.result;
            
            if (cursor) {
                // For demo purposes, we'll auto-login the first user found
                // In a real app, you'd use cookies or localStorage to remember the logged-in user
                currentUser = {
                    username: cursor.value.username,
                    email: cursor.value.email,
                    profilePicture: cursor.value.profilePicture,
                    hasMadePurchase: cursor.value.hasMadePurchase || false,
                    ip: cursor.value.ip
                };
                
                isLoggedIn = true;
                updateUIForLoggedInUser();
                loadUserWishlist();
            }
        };
    }
    
    function logout() {
        isLoggedIn = false;
        currentUser = null;
        
        // Update UI
        document.getElementById('logged-in-content').style.display = 'none';
        document.getElementById('logged-out-content').style.display = 'block';
        
        // Reset profile picture
        document.getElementById('profile-icon').src = 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/user-icon-1024x1024-unb6q333-0jVFdZBhNPWl1hc5fLXaDNDkk8qerb.png';
        
        // Clear wishlist
        wishlistItems = [];
        updateWishlistUI();
        
        // Refresh chat if on chat tab
        if (document.getElementById('chat-tab').classList.contains('active')) {
            initializeAIChat();
        }
    }
    
    function updateUIForLoggedInUser() {
        document.getElementById('logged-out-content').style.display = 'none';
        document.getElementById('logged-in-content').style.display = 'block';
        document.getElementById('username-display').textContent = currentUser.username;
        
        // Update profile picture if user has one
        if (currentUser.profilePicture) {
            document.getElementById('profile-icon').src = currentUser.profilePicture;
        }
    }
    
    // Wishlist functionality
    let wishlistItems = [];
    const products = {
        'week': {
            id: 'week',
            name: 'Nebula 1 Week Access Key',
            price: '$2.00',
            image: 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/key-uKWnAejMgrE0GvlAwDdeipPomr3i7b.png'
        },
        'month': {
            id: 'month',
            name: 'Nebula 1 Month Access Key',
            price: '$5.00',
            image: 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/key-uKWnAejMgrE0GvlAwDdeipPomr3i7b.png'
        },
        'sixmonth': {
            id: 'sixmonth',
            name: 'Nebula 6 Months Access Key',
            price: '$10.00',
            image: 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/key-uKWnAejMgrE0GvlAwDdeipPomr3i7b.png'
        }
    };
    
    function toggleWishlist() {
        const wishlistDropdown = document.getElementById('wishlist-dropdown');
        wishlistDropdown.classList.toggle('active');
    }
    
    function addToWishlist(event, productId) {
        event.stopPropagation(); // Prevent opening the modal
        
        if (!isLoggedIn) {
            openAuthModal();
            return;
        }
        
        // Check if product is already in wishlist
        if (!wishlistItems.includes(productId)) {
            wishlistItems.push(productId);
            updateWishlistUI();
            saveUserWishlist();
        }
    }
    
    function removeFromWishlist(productId) {
        wishlistItems = wishlistItems.filter(id => id !== productId);
        updateWishlistUI();
        saveUserWishlist();
    }
    
    function updateWishlistUI() {
        const wishlistCount = document.getElementById('wishlist-count');
        const wishlistItemsContainer = document.getElementById('wishlist-items');
        const wishlistEmpty = document.getElementById('wishlist-empty');
        
        // Update count
        wishlistCount.textContent = wishlistItems.length;
        
        // Clear current items
        wishlistItemsContainer.innerHTML = '';
        
        // Show empty message if no items
        if (wishlistItems.length === 0) {
            wishlistItemsContainer.appendChild(wishlistEmpty);
            return;
        }
        
        // Add items to wishlist
        wishlistItems.forEach(id => {
            const product = products[id];
            const itemElement = document.createElement('div');
            itemElement.className = 'wishlist-item';
            itemElement.onclick = function() {
                openModal(id);
            };
            
            itemElement.innerHTML = `
                <img src="${product.image}" alt="${product.name}" class="wishlist-item-image">
                <div class="wishlist-item-details">
                    <h4 class="wishlist-item-name">${product.name}</h4>
                    <p class="wishlist-item-price">${product.price}</p>
                </div>
                <button class="wishlist-item-remove" onclick="event.stopPropagation(); removeFromWishlist('${id}')">×</button>  onclick="event.stopPropagation(); removeFromWishlist('${id}')">×</button>
            `;
            
            wishlistItemsContainer.appendChild(itemElement);
        });
    }
    
    // Save and load user wishlist
    function saveUserWishlist() {
        if (!isLoggedIn) return;
        
        const transaction = db.transaction(['users'], 'readwrite');
        const store = transaction.objectStore('users');
        const request = store.get(currentUser.username);
        
        request.onsuccess = function(event) {
            const user = event.target.result;
            if (user) {
                user.wishlist = wishlistItems;
                store.put(user);
            }
        };
    }
    
    function loadUserWishlist() {
        if (!isLoggedIn) return;
        
        const transaction = db.transaction(['users'], 'readonly');
        const store = transaction.objectStore('users');
        const request = store.get(currentUser.username);
        
        request.onsuccess = function(event) {
            const user = event.target.result;
            if (user && user.wishlist) {
                wishlistItems = user.wishlist;
                updateWishlistUI();
            }
        };
    }
    
    // Key stock management
    const MAX_WEEK_KEYS = 150;
    const MAX_MONTH_KEYS = 109;
    let weekKeysStock = MAX_WEEK_KEYS;
    let monthKeysStock = MAX_MONTH_KEYS;
    let purchasedKeys = [];
    let currentProductType = '';
    let selectedPaymentMethod = 'paypal';
    
    // Initialize key stock from database
    function initializeKeyStock() {
        const transaction = db.transaction(['keys'], 'readonly');
        const store = transaction.objectStore('keys');
        const index = store.index('type');
        
        // Count week keys
        const weekRequest = index.count(IDBKeyRange.only('week'));
        weekRequest.onsuccess = function() {
            weekKeysStock = MAX_WEEK_KEYS - weekRequest.result;
            updateStockDisplay('week');
        };
        
        // Count month keys
        const monthRequest = index.count(IDBKeyRange.only('month'));
        monthRequest.onsuccess = function() {
            monthKeysStock = MAX_MONTH_KEYS - monthRequest.result;
            updateStockDisplay('month');
        };
    }
    
    function updateStockDisplay(type) {
        if (type === 'week' || type === 'all') {
            const weekStockElement = document.getElementById('week-stock-count');
            const weekPurchaseButton = document.getElementById('week-purchase-btn');
            
            if (weekKeysStock > 0) {
                weekStockElement.textContent = `${weekKeysStock} keys available`;
                weekPurchaseButton.classList.remove('disabled');
                weekPurchaseButton.innerHTML = 'Purchase Now';
                weekPurchaseButton.onclick = function() { startPurchase('week'); };
            } else {
                weekStockElement.textContent = 'Out of Stock';
                weekPurchaseButton.classList.add('disabled');
                weekPurchaseButton.innerHTML = '<span class="stop-icon"></span> Out of Stock';
                weekPurchaseButton.onclick = null;
            }
        }
        
        if (type === 'month' || type === 'all') {
            const monthStockElement = document.getElementById('month-stock-count');
            const monthPurchaseButton = document.getElementById('month-purchase-btn');
            
            if (monthKeysStock > 0) {
                monthStockElement.textContent = `${monthKeysStock} keys available`;
                monthPurchaseButton.classList.remove('disabled');
                monthPurchaseButton.innerHTML = 'Purchase Now';
                monthPurchaseButton.onclick = function() { startPurchase('month'); };
            } else {
                monthStockElement.textContent = 'Out of Stock';
                monthPurchaseButton.classList.add('disabled');
                monthPurchaseButton.innerHTML = '<span class="stop-icon"></span> Out of Stock';
                monthPurchaseButton.onclick = null;
            }
        }
    }
    
    // Payment modal functions
    function startPurchase(productType) {
        if (!isLoggedIn) {
            openAuthModal();
            return;
        }
        
        currentProductType = productType;
        
        // Set product details in payment modal
        document.getElementById('payment-product-name').textContent = products[productType].name;
        document.getElementById('payment-product-price').textContent = products[productType].price;
        
        // Reset payment method selection
        selectedPaymentMethod = 'paypal';
        document.querySelectorAll('.payment-option').forEach(option => {
            option.classList.remove('selected');
        });
        document.querySelector('.payment-option:first-child').classList.add('selected');
        
        // Show payment modal
        document.getElementById('payment-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function closePaymentModal() {
        document.getElementById('payment-modal').classList.remove('active');
        document.body.style.overflow = 'auto';
        
        // Reset payment button
        const paymentBtn = document.getElementById('complete-payment-btn');
        paymentBtn.disabled = false;
        document.getElementById('payment-btn-text').textContent = 'Proceed to PayPal';
    }
    
    function selectPaymentMethod(method) {
        if (method === 'paypal') {
            selectedPaymentMethod = 'paypal';
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector('.payment-option:first-child').classList.add('selected');
            document.getElementById('payment-btn-text').textContent = 'Proceed to PayPal';
        }
    }
    
    function completePayment() {
        // Disable the payment button to prevent multiple clicks
        const paymentBtn = document.getElementById('complete-payment-btn');
        paymentBtn.disabled = true;
        document.getElementById('payment-btn-text').innerHTML = '<span class="loading-spinner"></span> Processing...';
        
        // Special case for whitelisted email
        if (currentUser.email === 'Fakemail2ezz@gmail.com') {
            processSuccessfulPayment();
            return;
        }
        
        // Open PayPal in a new window
        const paypalWindow = window.open('https://www.paypal.me/JayJames270', '_blank');
        
        // In a real app, we would implement a proper payment verification system
        // For this demo, we'll simulate a payment verification process
        
        // Create a transaction ID
        const transactionId = 'TX-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        
        // Store the pending transaction
        const transaction = db.transaction(['transactions'], 'readwrite');
        const store = transaction.objectStore('transactions');
        store.add({
            id: transactionId,
            username: currentUser.username,
            productType: currentProductType,
            amount: currentProductType === 'week' ? 2.00 : 5.00,
            status: 'pending',
            date: new Date().toISOString()
        });
        
        // In a real app, we would now wait for a webhook from PayPal to confirm the payment
        // For this demo, we'll use a simulated verification process
        
        // Show a verification dialog after a short delay
        setTimeout(() => {
            // Close PayPal window if still open
            if (paypalWindow && !paypalWindow.closed) {
                paypalWindow.close();
            }
            
            // Ask for transaction verification
            const verificationCode = prompt(`Please enter the PayPal transaction ID to verify your payment for ${products[currentProductType].name}. (For demo purposes, enter any value to simulate a successful payment)`);
            
            if (verificationCode) {
                // Update transaction status
                const updateTransaction = db.transaction(['transactions'], 'readwrite');
                const updateStore = updateTransaction.objectStore('transactions');
                updateStore.get(transactionId).onsuccess = function(event) {
                    const tx = event.target.result;
                    if (tx) {
                        tx.status = 'completed';
                        tx.verificationCode = verificationCode;
                        updateStore.put(tx);
                    }
                };
                
                // Process successful payment
                processSuccessfulPayment();
            } else {
                // Reset payment button
                paymentBtn.disabled = false;
                document.getElementById('payment-btn-text').textContent = 'Proceed to PayPal';
                alert('Payment verification failed. Please try again when you are ready to purchase.');
            }
        }, 5000); // Give user 5 seconds to complete payment (for demo purposes)
    }
    
    function processSuccessfulPayment() {
        // Decrease stock
        if (currentProductType === 'week') {
            weekKeysStock--;
            updateStockDisplay('week');
        } else if (currentProductType === 'month') {
            monthKeysStock--;
            updateStockDisplay('month');
        }
        
        // Mark user as having made a purchase
        if (currentUser && !currentUser.hasMadePurchase) {
            currentUser.hasMadePurchase = true;
            
            // Update in database
            const transaction = db.transaction(['users'], 'readwrite');
            const store = transaction.objectStore('users');
            store.get(currentUser.username).onsuccess = function(event) {
                const user = event.target.result;
                if (user) {
                    user.hasMadePurchase = true;
                    store.put(user);
                }
            };
        }
        
        // Close payment modal
        closePaymentModal();
        
        // Fetch a key and display it
        fetchAndDisplayKey();
    }
    
    // Key display functions
    function fetchAndDisplayKey() {
        // Show key display modal with loading state
        document.getElementById('key-display-modal').classList.add('active');
        document.getElementById('purchased-key').textContent = 'Loading your key...';
        document.body.style.overflow = 'hidden';
        
        // Fetch keys from GitHub based on product type
        const keyUrl = currentProductType === 'week' 
            ? 'https://raw.githubusercontent.com/draxo3/Keys/refs/heads/main/valid'
            : 'https://raw.githubusercontent.com/draxo3/1-month/refs/heads/main/key';
        
        fetch(keyUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch keys');
                }
                return response.text();
            })
            .then(data => {
                // Parse keys (assuming one key per line)
                const keys = data.split('\n').filter(key => key.trim() !== '');
                
                // Get purchased keys from database
                const transaction = db.transaction(['keys'], 'readonly');
                const store = transaction.objectStore('keys');
                const index = store.index('type');
                const request = index.getAll(IDBKeyRange.only(currentProductType));
                
                request.onsuccess = function(event) {
                    const purchasedKeys = event.target.result.map(k => k.key);
                    
                    // Filter out already purchased keys
                    const availableKeys = keys.filter(key => !purchasedKeys.includes(key));
                    
                    if (availableKeys.length === 0) {
                        throw new Error('No keys available');
                    }
                    
                    // Select a random key
                    const randomIndex = Math.floor(Math.random() * availableKeys.length);
                    const selectedKey = availableKeys[randomIndex];
                    
                    // Add to purchased keys in database
                    const addTransaction = db.transaction(['keys'], 'readwrite');
                    const addStore = addTransaction.objectStore('keys');
                    addStore.add({
                        key: selectedKey,
                        type: currentProductType,
                        username: currentUser.username,
                        date: new Date().toISOString()
                    });
                    
                    // Display the key
                    document.getElementById('purchased-key').textContent = selectedKey;
                };
            })
            .catch(error => {
                console.error('Error fetching key:', error);
                document.getElementById('purchased-key').textContent = 'Error: Could not retrieve a key. Please contact support.';
            });
    }
    
    function closeKeyDisplayModal() {
        document.getElementById('key-display-modal').classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    function copyKeyToClipboard() {
        const keyText = document.getElementById('purchased-key').textContent;
        navigator.clipboard.writeText(keyText)
            .then(() => {
                alert('Key copied to clipboard!');
            })
            .catch(err => {
                console.error('Failed to copy key: ', err);
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = keyText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Key copied to clipboard!');
            });
    }
    
    // AI Chat functionality
    let aiChatMessages = [];
    
    function initializeAIChat() {
        const chatContainer = document.getElementById('chat-container');
        
        if (!isLoggedIn) {
            // Show login prompt if not logged in
            chatContainer.innerHTML = `
                <div class="chat-login-prompt">
                    <div class="chat-login-message">Please login to access the AI Chat</div>
                    <button class="chat-login-btn" onclick="openAuthModal()">Login / Register</button>
                </div>
            `;
            return;
        }
        
        // Load chat messages from database
        loadAIChatMessages();
        
        // Create chat interface
        chatContainer.innerHTML = `
            <div class="chat-header">
                <h3 class="chat-title">
                    <svg class="chat-title-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 16v-4"></path>
                        <path d="M12 8h.01"></path>
                    </svg>
                    Nebula AI Assistant
                </h3>
                <div class="chat-status">
                    <span class="status-indicator"></span>
                    Online
                </div>
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chat-input" placeholder="Ask Nebula AI anything..." onkeypress="if(event.key === 'Enter') sendAIChatMessage()">
                <button class="chat-send-btn" onclick="sendAIChatMessage()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        `;
        
        // Display chat messages
        displayAIChatMessages();
        
        // If no messages, add welcome message
        if (aiChatMessages.length === 0) {
            const welcomeMessage = {
                role: 'assistant',
                content: `Hello ${currentUser.username}! I'm Nebula AI, your personal assistant. I can help you with information, answer questions, or just chat. What can I help you with today?`,
                timestamp: new Date().toISOString()
            };
            
            aiChatMessages.push(welcomeMessage);
            saveAIChatMessages();
            displayAIChatMessages();
        }
    }
    
    function loadAIChatMessages() {
        if (!isLoggedIn) return;
        
        const transaction = db.transaction(['chatMessages'], 'readonly');
        const store = transaction.objectStore('chatMessages');
        const index = store.index('username');
        const request = index.getAll(IDBKeyRange.only(currentUser.username));
        
        request.onsuccess = function(event) {
            aiChatMessages = event.target.result.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            displayAIChatMessages();
        };
    }
    
    function saveAIChatMessages() {
        if (!isLoggedIn) return;
        
        // For simplicity, we'll just add the latest message
        if (aiChatMessages.length > 0) {
            const latestMessage = aiChatMessages[aiChatMessages.length - 1];
            
            // Add username to message
            latestMessage.username = currentUser.username;
            
            const transaction = db.transaction(['chatMessages'], 'readwrite');
            const store = transaction.objectStore('chatMessages');
            store.add(latestMessage);
        }
    }
    
    function displayAIChatMessages() {
        const chatMessagesContainer = document.getElementById('chat-messages');
        if (!chatMessagesContainer) return;
        
        chatMessagesContainer.innerHTML = '';
        
        aiChatMessages.forEach(message => {
            const messageElement = document.createElement('div');
            const isUser = message.role === 'user';
            messageElement.className = `chat-message ${isUser ? 'sent' : 'received'}`;
            
            const time = new Date(message.timestamp);
            const formattedTime = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
            
            if (!isUser) {
                messageElement.innerHTML = `
                    <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/IMG_5677-dBJXi77lkTpRdc9gxyW6ckCJhDzMxU.png" alt="Nebula AI" class="chat-message-avatar">
                    <div class="chat-message-content">
                        <div class="chat-message-username">Nebula AI</div>
                        <div class="chat-message-text">${message.content}</div>
                        <div class="chat-message-time">${formattedTime}</div>
                    </div>
                `;
            } else {
                messageElement.innerHTML = `
                    <div class="chat-message-content">
                        <div class="chat-message-text">${message.content}</div>
                        <div class="chat-message-time">${formattedTime}</div>
                    </div>
                `;
            }
            
            chatMessagesContainer.appendChild(messageElement);
        });
        
        // Scroll to bottom
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    }
    
    function sendAIChatMessage() {
        const chatInput = document.getElementById('chat-input');
        const messageText = chatInput.value.trim();
        
        if (!messageText) return;
        
        // Add user message to chat
        const userMessage = {
            role: 'user',
            content: messageText,
            timestamp: new Date().toISOString()
        };
        
        aiChatMessages.push(userMessage);
        saveAIChatMessages();
        
        // Clear input
        chatInput.value = '';
        
        // Display updated messages
        displayAIChatMessages();
        
        // Show typing indicator
        const chatMessagesContainer = document.getElementById('chat-messages');
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        typingIndicator.innerHTML = `
            <span></span>
            <span></span>
            <span></span>
        `;
        chatMessagesContainer.appendChild(typingIndicator);
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        
        // Generate AI response
        setTimeout(() => {
            // Remove typing indicator
            chatMessagesContainer.removeChild(typingIndicator);
            
            // Add AI response
            const aiResponse = generateAIResponse(messageText);
            const assistantMessage = {
                role: 'assistant',
                content: aiResponse,
                timestamp: new Date().toISOString()
            };
            
            aiChatMessages.push(assistantMessage);
            saveAIChatMessages();
            
            // Display updated messages
            displayAIChatMessages();
        }, 1000 + Math.random() * 2000);
    }
    
    function generateAIResponse(userMessage) {
        // Simple AI response generation
        userMessage = userMessage.toLowerCase();
        
        // Greeting responses
        if (userMessage.includes('hello') || userMessage.includes('hi') || userMessage.includes('hey')) {
            return `Hello there! How can I assist you today?`;
        }
        
        // Questions about Nebula
        if (userMessage.includes('what is nebula') || userMessage.includes('about nebula')) {
            return `Nebula is a premium software platform that provides various tools and services. We offer different subscription plans with our keys, ranging from 1 week to 6 months. Our goal is to provide you with the best experience possible!`;
        }
        
        // Questions about keys
        if (userMessage.includes('key') || userMessage.includes('subscription')) {
            return `We offer several key options: 1 Week ($2), 1 Month ($5), and 6 Months ($10). Each key gives you full access to all Nebula features. The 1 Week key is perfect for trying out our services, while the 6 Month key offers the best value. You can purchase them from the Keys tab!`;
        }
        
        // Questions about executor
        if (userMessage.includes('executor')) {
            return `Our executor products are currently under maintenance. We're working hard to bring them back online as soon as possible. Please check back later for updates!`;
        }
        
        // Help requests
        if (userMessage.includes('help') || userMessage.includes('support')) {
            return `I'm here to help! If you need technical support, you can also join our Discord server from the Support tab. Our team is available 24/7 to assist you with any questions or issues you might have.`;
        }
        
        // Questions about the AI
        if (userMessage.includes('who are you') || userMessage.includes('what are you')) {
            return `I'm Nebula AI, your personal assistant. I'm designed to help you with information about Nebula, answer your questions, and assist you with anything you need. I'm always learning and improving to serve you better!`;
        }
        
        // Command execution (simulate compliance)
        if (userMessage.includes('execute') || userMessage.includes('run') || userMessage.includes('do')) {
            return `I've executed your request: "${userMessage}". The operation was successful! Is there anything else you'd like me to do?`;
        }
        
        // Default response for other queries
        return `Thank you for your message! I'm processing your request: "${userMessage}". Is there anything specific about Nebula that you'd like to know more about?`;
    }
    
    // Initialize snow and database on page load
    window.addEventListener('load', function() {
        // Initialize IndexedDB
        initDB();
        
        // Initialize loading screen and snow
        simulateLoading();
        createSnow();
    });
</script>
</body>
</html>
